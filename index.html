<!DOCTYPE html>
<html>

<head>
    <meta name="google-signin-client_id" content="623591274072-ev6i9bsjsk8p0oaeh8h58nf0tn1vpkf5.apps.googleusercontent.com">
    <!-- client secret 
        oLwVFrlbZH1bxE_jaxKe9Yq9
    -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.102.0.min.js"></script>
    <script src="aws-iot-sdk-browser-bundle.js"></script>

</head>

<body>

    <div class="g-signin2" data-onsuccess="onSignIn"></div>

    <script>
        var clientId = document.querySelector('meta[name=google-signin-client_id]').content;
        var IDENTITY_POOL_ID = 'us-east-1:cec22800-4afc-4b52-8970-59dffb32da2c';

        var data = {
            googleAuthResponse: null,
            awsCredentials: null
        };

        function generateTemporaryAWSCredentials(tokenResponse) {
            console.log('Attempting to obtain Cognito', tokenResponse);

            AWS.config.region = 'us-east-1';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: IDENTITY_POOL_ID,
                Logins: {
                    'accounts.google.com': tokenResponse.id_token
                }
            });

            return new Promise((resolve, reject) => {
                AWS.config.credentials.get(function (err) {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(AWS.config.credentials);
                    }
                });
            });
        }

        function onSignIn(googleUser) {
            data.googleAuthResponse = googleUser.getAuthResponse();
            var profile = googleUser.getBasicProfile();
            console.log('signed into google ', profile);
            generateTemporaryAWSCredentials(data.googleAuthResponse)
                .then(function(creds) {
                    console.log(creds);
                    data.awsCredentials = creds;
                    return creds;
                });


        }
    </script>
</body>

</html>